(in-package :oou)(oou-provide :text-mode-fred-mixin);*****************************************************************                                    ;; Copyright © 1991 Institut fuer Informatik, University of Basel, Switzerland ; All Rights Reserved;; Author: Dieter Holz;; a mixin for fred. the main lisp-mode-features are eliminated and you can use it as a text-editor; has to be completed ;; Changes (worth to be mentioned):; ------------------------------; none ;;*****************************************************************;*****************************************************************(oou-dependencies :simple-view-ce                                ) (export '(text-mode-fred-mixin                 ));---------------------------- -------------------------------------(defclass text-mode-fred-mixin ()    ())(defmethod initialize-instance :after ((ob text-mode-fred-mixin) &rest initargs)     (declare (ignore initargs))    (comtab-set-key (slot-value ob 'comtab) 9 #'ed-insert-tab)    (comtab-set-key (slot-value ob 'comtab) #\Help #'ignore-this-key)    (comtab-set-key (slot-value ob 'comtab)'(:meta #\UpArrow) #'upcase-word)    (comtab-set-key (slot-value ob 'comtab)'(:control #\UpArrow) #'upcase-word)    (comtab-set-key (slot-value ob 'comtab)'(:meta #\DownArrow) #'downcase-word)   (comtab-set-key (slot-value ob 'comtab)'(:control #\DownArrow) #'downcase-word)     (comtab-set-key (slot-value ob 'comtab)'(:meta #\5) #'insert-[)    (comtab-set-key (slot-value ob 'comtab)'(:meta #\6) #'insert-])    (comtab-set-key (slot-value ob 'comtab)'(:meta #\8) #'insert-{)    (comtab-set-key (slot-value ob 'comtab)'(:meta #\9) #'insert-})    (comtab-set-key (slot-value ob 'comtab) '(:meta #\/) #'insert-backslash)    (comtab-set-key (slot-value ob 'comtab)'(:meta #\7) #'insert-delimiter)    (comtab-set-key (slot-value ob 'comtab)'(:control #\-) #'insert-left-dash)    (comtab-set-key (slot-value ob 'comtab)'(:control  #\_) #'insert-right-dash)    )(defmethod insert-left-dash ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) "--~"))(defmethod insert-right-dash ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) "~--"))(defmethod ed-insert-tab ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\tab))(defmethod insert-[ ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\[))(defmethod insert-] ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\]))(defmethod insert-{ ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\{))(defmethod insert-} ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\}))(defmethod insert-backslash ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\\))(defmethod insert-delimiter ((self text-mode-fred-mixin))    (buffer-insert (fred-buffer self) #\|))(defmethod ignore-this-key ((self text-mode-fred-mixin))    nil)(defmethod fred-blink-position ((self text-mode-fred-mixin))    nil); added '-' '§','"'      '.' deleted(defvar *text-mode-fred-word-constituents*   "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@$\"%^&*_-+=<>?|€‚ƒ„…†‡ˆ‰Š‹ŒŽ‘’“”•–—˜™š›œžŸ§ËÌÍåæçèéêëìíîïñòóô")(defvar *default-mode-fred-word-constituents* ccl::*fred-word-constituents*)(defmethod view-activate-event-handler :before ((self text-mode-fred-mixin))    (setf ccl::*fred-word-constituents* *text-mode-fred-word-constituents*)    (setf *arglist-on-space* nil))(defmethod view-deactivate-event-handler :after ((self text-mode-fred-mixin))    (setf ccl::*fred-word-constituents* *default-mode-fred-word-constituents*)    (setf *arglist-on-space* t))(defun char-toggle-case (char)    (if (char>= char #\a)        (char-upcase char)        (char-downcase char)))(defmethod toggle-case-word ((self text-mode-fred-mixin))    (let* ((buff (fred-buffer self))                (current-pos (buffer-position buff))                (toggle-pos current-pos))        (when (> (buffer-size buff) 0)             (unless (= (1+ (or (ccl::buffer-backward-find-char buff *wsp* (buffer-position buff) (buffer-line-start buff))                                               (1- (buffer-line-start buff))))                                 current-pos)                 (ed-backward-word self))             (setf toggle-pos (1- (or (ccl::buffer-forward-find-not-char buff "\"-'" (buffer-position buff) (buffer-line-end buff))                                                       (1+ current-pos))))             (when (< toggle-pos (buffer-size buff))                  (buffer-char-replace buff (char-toggle-case (buffer-char buff toggle-pos)) toggle-pos)                  (move-mark buff  1)                  (ed-downcase-word self)                  (set-mark buff current-pos)))))(defmethod upcase-word ((self text-mode-fred-mixin))    (let* ((buff (fred-buffer self))                (current-pos (buffer-position buff))                (toggle-pos current-pos)                (end-of-word-pos  (or (ccl::buffer-forward-find-char buff *wsp* current-pos (buffer-line-end buff))                                                        (buffer-line-end buff))))        (when (> (buffer-size buff) 0)             (unless (= (1+ (or (ccl::buffer-backward-find-char buff *wsp* (buffer-position buff) (buffer-line-start buff))                                               (1- (buffer-line-start buff))))                                 current-pos)                 (ed-backward-word self))             (setf toggle-pos (or (ccl::buffer-forward-find-not-char buff "\"-'" (buffer-position buff) (buffer-line-end buff))                                               current-pos))             (when (< toggle-pos (buffer-size buff))                  (ed-downcase-word self)                  (do ((pos toggle-pos                                    (ccl::buffer-forward-find-not-char buff "\"'"                                                                                                 (or (ccl::buffer-forward-find-char buff "-" (1+ pos) end-of-word-pos)                                                                                                       end-of-word-pos)                                                                                                 end-of-word-pos )))                         ((or (null pos)                                  (>= pos  end-of-word-pos)))                      (buffer-char-replace buff (char-upcase (buffer-char buff (1- pos))) (1- pos)))                  (set-mark buff current-pos)))))(defmethod downcase-word ((self text-mode-fred-mixin))    (let* ((buff (fred-buffer self))                (current-pos (buffer-position buff))                (toggle-pos current-pos))        (when (> (buffer-size buff) 0)             (unless (= (1+ (or (ccl::buffer-backward-find-char buff *wsp* (buffer-position buff) (buffer-line-start buff))                                               (1- (buffer-line-start buff))))                                 current-pos)                 (ed-backward-word self))             (setf toggle-pos (1- (or (ccl::buffer-forward-find-not-char buff "\"-'" (buffer-position buff) (buffer-line-end buff))                                                       (1+ current-pos))))             (when (< toggle-pos (buffer-size buff))                  ;(buffer-char-replace buff (char-downcase (buffer-char buff toggle-pos)) toggle-pos)                  ;(move-mark buff  1)                  (ed-downcase-word self)                  (set-mark buff current-pos)))))(defmethod view-click-event-handler :around ((self text-mode-fred-mixin) where)    (declare (ignore where))    (cond ((= *multi-click-count* 3)        (collapse-selection self t)        (multiple-value-bind (start end) (paragraph-bounds self)          (set-selection-range self start end)                    (fred-update self)))              (t (call-next-method)                   (when (double-click-p)                        (multiple-value-bind (start end) (selection-range self)                             (when (and (/= start end)                                                 (char= (buffer-char (fred-buffer self) end) #\space)                                                 ;(find (buffer-char (fred-buffer self) end) *wsp* :test #'char=)                                                 )                                  (set-selection-range self start (1+ end))                                  (fred-update self)                                  ))))))#|(defclass my-fred-item (text-mode-fred-mixin fred-item)    ()    (:default-initargs :comtab (make-comtab))) ; be sure to have your own comtab(make-instance 'fred-window     :view-size #@(300 200)     :fred-item-class 'my-fred-item)|#